**tcp三次握手**

> 进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备。实质上其实就是连接服务器指定端口，建立TCP连接，并同步连接双方的序列号和确认号，交换TCP窗口大小信息。

[![6so2jK.png](https://s3.ax1x.com/2021/03/16/6so2jK.png)](https://imgtu.com/i/6so2jK)

第三次握手考验携带数据

**什么是半连接队列？**

> 服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为半连接队列。
>
> 当然还有一个全连接队列，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。

这里在补充一点关于SYN-ACK 重传次数的问题：

服务器发送完SYN-ACK包，如果未收到客户确认包，服务器进行首次重传，等待一段时间仍未收到客户确认包，进行第二次重传。如果重传次数超过系统规定的最大重传次数，系统将该连接信息从半连接队列中删除。

注意，每次重传等待的时间不一定相同，一般会是指数增长，例如间隔时间为 1s，2s，4s，8s…

**ISN = M + F(localhost, localport, remotehost, remoteport).**

**M**是一个计时器，这个计时器每隔4毫秒加1。



**SYN攻击是什么？**

> 服务器端的资源分配是在二次握手时分配的，而客户端的资源是在完成三次握手时分配的，所以服务器容易受到SYN洪泛攻击。SYN攻击就是Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包，Server则回复确认包，并等待Client确认，由于源地址不存在，因此Server需要不断重发直至超时，这些伪造的SYN包将长时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪。SYN 攻击是一种典型的 DoS/DDoS 攻击。



防御 SYN 攻击的方法有如下几种：

- 缩短超时（SYN Timeout）时间

- 增加最大半连接数

- 过滤网关防护

- SYN cookies技术

  > 在服务器收到客户端的第一次请求之后，不立马分配资源，而是将
  >
  > 1. SYN报文的源和目的IP与端口号
  > 2. 仅仅有服务器知道的密钥
  >
  > 塞入一个散列函数，生成一个认证码；这个认证码也叫cookie；将cookie作为初始序列号，相应给客户端。
  >
  > 如果客户端真实存在，则客户端将会带着cookie+1作为ack响应。而服务器可以再次执行上述过程，比较与ack-1是否相同。如果相同，则建立连接。如果客户端不存在，则服务器没有为其消耗任何资源。

  

tcp四次挥手 2msl

[![6yC3se.png](https://s3.ax1x.com/2021/03/16/6yC3se.png)](https://imgtu.com/i/6yC3se)

epoll select





1. IO多路复用，select，poll，epoll